name: Deploy to Staging

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Setup SSH agent, key, and known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts
          eval "$(ssh-agent -s)"
          # Add private key from secret; normalize CRLF to LF to avoid parse issues
          printf '%s' "${{ secrets.STAGING_SSH_KEY }}" | tr -d '\r' | ssh-add -
          # Also write key to a file for -i usage as a fallback
          printf '%s' "${{ secrets.STAGING_SSH_KEY }}" | tr -d '\r' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy via SSH
        env:
          SERVER: ${{ secrets.STAGING_HOST }}
        run: |
          # Preflight: verbose SSH to validate auth and show which key is offered
          ssh -vvv -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes bibhu342@${SERVER} 'echo preflight-ok'

          # Deploy via heredoc
          ssh -i ~/.ssh/deploy_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes bibhu342@${SERVER} << 'ENDSSH'
            set -euo pipefail

            # Ensure ~/app exists and is a git repo
            if [ ! -d ~/app ]; then
              mkdir -p ~/app
            fi
            cd ~/app
            if [ ! -d .git ]; then
              git init
              git remote add origin ${{ github.server_url }}/${{ github.repository }}.git
            fi

            # Fetch the tag and checkout
            git fetch --depth=1 origin ${{ github.ref }}
            git checkout -B staging-deploy FETCH_HEAD

            # Navigate to deploy/staging
            cd deploy/staging

            # Verify .env.staging exists
            if [ ! -f .env.staging ]; then
              echo "ERROR: .env.staging not found"
              exit 1
            fi

            # Export image variables
            export IMAGE_NAME=${{ github.repository }}
            export IMAGE_TAG=${{ github.ref_name }}

            # Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest images (ignore failures to allow first-time builds)
            docker compose pull || true

            # Run migrations
            docker compose run --rm api alembic upgrade head

            # Start services
            docker compose up -d

            # Run smoke tests
            sleep 10
            chmod +x smoke.sh
            ./smoke.sh
          ENDSSH
