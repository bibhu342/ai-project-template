name: Deploy to Staging

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via SSH
        env:
          SERVER: ${{ secrets.STAGING_HOST }}
          USER: ${{ secrets.STAGING_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes ${USER}@${SERVER} << 'ENDSSH'
            set -euo pipefail

            # Ensure ~/app exists and is a git repo
            if [ ! -d ~/app ]; then
              mkdir -p ~/app
            fi
            cd ~/app
            if [ ! -d .git ]; then
              git init
              git remote add origin ${{ github.server_url }}/${{ github.repository }}.git
            fi

            # Fetch the tag and checkout
            git fetch --depth=1 origin ${{ github.ref }}
            git checkout -B staging-deploy FETCH_HEAD

            # Navigate to deploy/staging
            cd deploy/staging

            # Verify .env.staging exists
            if [ ! -f .env.staging ]; then
              echo "ERROR: .env.staging not found"
              exit 1
            fi

            # Export image variables
            export IMAGE_NAME=${{ github.repository }}
            export IMAGE_TAG=${{ github.ref_name }}

            # Login to GHCR
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest images (ignore failures to allow first-time builds)
            docker compose pull || true

            # Run migrations
            docker compose run --rm api alembic upgrade head

            # Start services
            docker compose up -d

            # Run smoke tests
            sleep 10
            chmod +x smoke.sh
            ./smoke.sh
          ENDSSH
