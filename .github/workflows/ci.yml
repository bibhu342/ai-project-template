- name: Install deps
  run: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
    # safety net in case alembic isn't in requirements yet
    pip install alembic psycopg2-binary pytest httpx

- name: Wait for Postgres
  run: |
    sudo apt-get update -y
    sudo apt-get install -y postgresql-client
    for i in {1..30}; do
      pg_isready -h localhost -p 5432 && break
      sleep 1
    done

- name: Run migrations
  env:
    DATABASE_URL: postgresql+psycopg2://bibhu:bibhu@localhost:5432/ai_lab
  run: alembic upgrade head

- name: Run tests
  env:
    DATABASE_URL: postgresql+psycopg2://bibhu:bibhu@localhost:5432/ai_lab
  run: pytest -q
